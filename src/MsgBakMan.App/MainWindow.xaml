<Window x:Class="MsgBakMan.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:MsgBakMan.App"
        xmlns:conv="clr-namespace:MsgBakMan.App.Converters"
    xmlns:ui="http://schemas.modernwpf.com/2019"
        mc:Ignorable="d"
    ui:WindowHelper.UseModernWindowStyle="True"
        Title="Message Backup Manager" Height="600" Width="920" WindowState="Maximized" Icon="Assets/msgbakman.ico">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
        <conv:EmptyCollectionToVisibilityConverter x:Key="EmptyToVis" />
        <conv:ZeroCountToVisibilityConverter x:Key="ZeroToVis" />
    </Window.Resources>
    <Grid Background="{DynamicResource AppBackgroundBrush}" Margin="14">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Top app bar -->
        <Border Grid.Row="0" Style="{StaticResource CardBorderStyle}" Padding="16" Margin="0,0,0,14">
            <DockPanel LastChildFill="False">
                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" VerticalAlignment="Center">
                    <Grid Width="36" Height="36" Margin="0,0,12,0" SnapsToDevicePixels="True" UseLayoutRounding="True">
                        <Border Background="{DynamicResource AccentBrush}" CornerRadius="10" />

                        <!-- Bubble + tail -->
                        <Canvas>
                            <Border Canvas.Left="7" Canvas.Top="7" Width="22" Height="18"
                                    Background="{DynamicResource AppBackgroundBrush}"
                                    CornerRadius="7" />
                            <Polygon Points="13,24 19,24 15,29"
                                     Fill="{DynamicResource AppBackgroundBrush}" />

                            <!-- Dots -->
                            <Ellipse Canvas.Left="12" Canvas.Top="15" Width="3" Height="3" Fill="{DynamicResource AccentBrush}" />
                            <Ellipse Canvas.Left="16.5" Canvas.Top="15" Width="3" Height="3" Fill="{DynamicResource AccentBrush}" />
                            <Ellipse Canvas.Left="21" Canvas.Top="15" Width="3" Height="3" Fill="{DynamicResource AccentBrush}" />
                        </Canvas>
                    </Grid>
                    <StackPanel>
                        <TextBlock Text="Message Backup Manager" Style="{StaticResource AppTitleTextStyle}" />
                        <TextBlock Text="Import, merge, and export SMS backups." Style="{StaticResource AppSubtitleTextStyle}" />
                    </StackPanel>
                </StackPanel>

                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Center">
                    <Border Style="{StaticResource RoundedInputBorderStyle}" Padding="10,3" Margin="0,0,12,0" VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <Ellipse Width="10" Height="10" Fill="{DynamicResource AccentBrush}" Margin="0,0,8,0" />
                            <ComboBox ItemsSource="{Binding AccentPalettes}"
                                      SelectedItem="{Binding SelectedAccentPalette, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                      MinWidth="110"
                                      Style="{StaticResource CompactComboBoxStyle}" />
                        </StackPanel>
                    </Border>
                    <ui:ToggleSwitch Header="Dark Mode" IsOn="{Binding IsDarkTheme, Mode=TwoWay}" Margin="0,0,12,0" VerticalAlignment="Center" />
                    <Button Content="About" Style="{StaticResource GhostButtonStyle}" Click="About_Click" />
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- Main content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="360" />
                <ColumnDefinition Width="12" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- Left sidebar -->
            <StackPanel Grid.Column="0">
                <Border Style="{StaticResource CardBorderStyle}">
                    <StackPanel>
                        <TextBlock Text="Project" Style="{StaticResource SectionHeaderTextStyle}" />
                        <TextBlock Text="Choose where to store the database + media." Style="{StaticResource MutedTextStyle}" Margin="0,4,0,0" />

                        <Border Style="{StaticResource RoundedInputBorderStyle}" Margin="0,12,0,0">
                            <DockPanel LastChildFill="True">
                                <TextBox Style="{StaticResource InputTextBoxStyle}" Text="{Binding ProjectFolder, UpdateSourceTrigger=PropertyChanged}" />
                                <Button DockPanel.Dock="Right" Content="Browse" Style="{StaticResource GhostButtonStyle}" Command="{Binding BrowseProjectFolderCommand}" Margin="10,0,0,0" />
                            </DockPanel>
                        </Border>

                        <TextBlock Text="DB: db/messages.sqlite • Media: media/blobs/" Style="{StaticResource MutedTextStyle}" Margin="0,10,0,0" />

                        <DockPanel Margin="0,12,0,0" LastChildFill="False">
                            <Button DockPanel.Dock="Right"
                                    Content="  Open folder  "
                                    Style="{StaticResource SecondaryButtonStyle}"
                                    Command="{Binding OpenProjectFolderCommand}" />
                        </DockPanel>
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource CardBorderStyle}" Margin="0,14,0,0">
                    <StackPanel>
                        <TextBlock Text="Actions" Style="{StaticResource SectionHeaderTextStyle}" />
                        <TextBlock Text="Import multiple backups and export one merged file." Style="{StaticResource MutedTextStyle}" Margin="0,4,0,0" />

                        <Button Content="Import XML" Style="{StaticResource PrimaryButtonStyle}" Margin="0,12,0,0" Command="{Binding ImportXmlCommand}" IsEnabled="{Binding IsNotBusy}" />
                        <Button Content="Export merged XML" Style="{StaticResource PrimaryButtonStyle}" Margin="0,10,0,0" Command="{Binding ExportXmlCommand}" IsEnabled="{Binding IsNotBusy}" />
                        <Button Content="Export media" Style="{StaticResource SecondaryButtonStyle}" Margin="0,10,0,0" Command="{Binding ExportMediaCommand}" IsEnabled="{Binding IsNotBusy}" />

                        <DockPanel Margin="0,12,0,0" LastChildFill="True">
                            <Button DockPanel.Dock="Right" Content="  Refresh  " Padding="14,6" Style="{StaticResource SecondaryButtonStyle}" Command="{Binding RefreshConversationsCommand}" IsEnabled="{Binding IsNotBusy}" />
                            <TextBlock Text="{Binding BusyText}" VerticalAlignment="Center" Style="{StaticResource MutedTextStyle}" Margin="0,0,10,0" />
                        </DockPanel>
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource CardBorderStyle}" Margin="0,14,0,0">
                    <StackPanel>
                        <TextBlock Text="Overview" Style="{StaticResource SectionHeaderTextStyle}" />
                        <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                            <Border Background="#10FFFFFF" CornerRadius="10" Padding="10" Margin="0,0,10,0">
                                <StackPanel>
                                    <TextBlock Text="Conversations" Style="{StaticResource MutedTextStyle}" />
                                    <TextBlock Text="{Binding ConversationCount}" FontSize="20" FontWeight="SemiBold" />
                                </StackPanel>
                            </Border>
                            <Border Background="#10FFFFFF" CornerRadius="10" Padding="10" Margin="0,0,10,0">
                                <StackPanel>
                                    <TextBlock Text="Messages" Style="{StaticResource MutedTextStyle}" />
                                    <TextBlock Text="{Binding ConversationMessageCount}" FontSize="20" FontWeight="SemiBold" />
                                </StackPanel>
                            </Border>
                            <Border Background="#10FFFFFF" CornerRadius="10" Padding="10">
                                <StackPanel>
                                    <TextBlock Text="Results" Style="{StaticResource MutedTextStyle}" />
                                    <TextBlock Text="{Binding SearchResultCount}" FontSize="20" FontWeight="SemiBold" />
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </StackPanel>

            <GridSplitter Grid.Column="1" Width="12" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="Transparent" />

            <!-- Right content -->
            <Border Grid.Column="2" Style="{StaticResource CardBorderStyle}" Padding="12">
                <TabControl>
                    <TabItem Header="Browse">
                        <Grid Margin="4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="420" MinWidth="320" />
                                <ColumnDefinition Width="10" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <!-- Conversations -->
                            <Border Grid.Column="0" Style="{StaticResource CardBorderStyle}" Padding="12">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="*" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <TextBlock Text="Conversations" Style="{StaticResource SectionHeaderTextStyle}" />

                                    <DockPanel Grid.Row="1" Margin="0,10,0,0" LastChildFill="True">
                                        <Button DockPanel.Dock="Right" Content="Clear" Style="{StaticResource GhostButtonStyle}" Command="{Binding ClearConversationSearchCommand}" Margin="8,0,0,0" Padding="10,6" MinWidth="52" />
                                        <Button DockPanel.Dock="Right" Content="Load" Style="{StaticResource SecondaryButtonStyle}" Command="{Binding RefreshConversationsCommand}" Padding="10,6" MinWidth="52" />
                                        <Border Style="{StaticResource RoundedInputBorderStyle}" Margin="0,0,10,0">
                                            <TextBox Style="{StaticResource InputTextBoxStyle}" Text="{Binding ConversationSearch, UpdateSourceTrigger=PropertyChanged}" />
                                        </Border>
                                    </DockPanel>

                                    <Grid Grid.Row="2" Margin="0,10,0,0">
                                        <DataGrid ItemsSource="{Binding Conversations}"
                                                  SelectedItem="{Binding SelectedConversation}"
                                                  AutoGenerateColumns="False"
                                                  CanUserAddRows="False"
                                                  HeadersVisibility="Column"
                                                  RowHeaderWidth="0"
                                                  AlternationCount="2"
                                                  GridLinesVisibility="Horizontal"
                                                  VirtualizingPanel.IsVirtualizing="True"
                                                  VirtualizingPanel.VirtualizationMode="Recycling">
                                            <DataGrid.Columns>
                                                <DataGridTemplateColumn Header="" Width="22">
                                                    <DataGridTemplateColumn.CellStyle>
                                                        <Style TargetType="DataGridCell">
                                                            <Setter Property="Padding" Value="0" />
                                                            <Setter Property="HorizontalContentAlignment" Value="Center" />
                                                        </Style>
                                                    </DataGridTemplateColumn.CellStyle>
                                                    <DataGridTemplateColumn.CellTemplate>
                                                        <DataTemplate>
                                                            <CheckBox IsChecked="{Binding IsChecked, Mode=TwoWay}" VerticalAlignment="Center" HorizontalAlignment="Center" Margin="0" />
                                                        </DataTemplate>
                                                    </DataGridTemplateColumn.CellTemplate>
                                                </DataGridTemplateColumn>

                                                <DataGridTextColumn Header="Conversation" Binding="{Binding Display}" Width="Auto" MinWidth="90">
                                                    <DataGridTextColumn.CellStyle>
                                                        <Style TargetType="DataGridCell">
                                                            <Setter Property="Padding" Value="0,0,6,0" />
                                                        </Style>
                                                    </DataGridTextColumn.CellStyle>
                                                    <DataGridTextColumn.ElementStyle>
                                                        <Style TargetType="TextBlock" BasedOn="{StaticResource EllipsisText}">
                                                            <Setter Property="HorizontalAlignment" Value="Left" />
                                                            <Setter Property="TextAlignment" Value="Left" />
                                                            <Setter Property="Margin" Value="0" />
                                                        </Style>
                                                    </DataGridTextColumn.ElementStyle>
                                                </DataGridTextColumn>
                                                <DataGridTextColumn Header="Last" Binding="{Binding LastWhenLocal, Mode=OneWay}" Width="160" ElementStyle="{StaticResource EllipsisText}" />
                                                <DataGridTextColumn Header="Msgs" Binding="{Binding MessageCount, Mode=OneWay}" Width="70" />
                                            </DataGrid.Columns>
                                        </DataGrid>

                                        <Border Background="#10FFFFFF"
                                                BorderBrush="{DynamicResource CardBorderBrush}"
                                                BorderThickness="1"
                                                CornerRadius="12"
                                            Visibility="{Binding ConversationCount, Converter={StaticResource ZeroToVis}}"
                                            IsHitTestVisible="False">
                                            <TextBlock TextAlignment="Center"
                                                       Style="{StaticResource MutedTextStyle}"
                                                       VerticalAlignment="Center">
                                                <Run Text="No conversations yet." />
                                                <LineBreak />
                                                <Run Text="Import XML and press Refresh." />
                                            </TextBlock>
                                        </Border>
                                    </Grid>

                                    <DockPanel Grid.Row="3" Margin="0,10,0,0" LastChildFill="False">
                                        <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                                            <Button Content="Check all" Style="{StaticResource GhostButtonStyle}" Command="{Binding CheckAllConversationsCommand}" />
                                            <Button Content="None" Style="{StaticResource GhostButtonStyle}" Command="{Binding UncheckAllConversationsCommand}" Margin="8,0,0,0" />
                                        </StackPanel>

                                        <Button DockPanel.Dock="Right"
                                                Content="  Merge checked  "
                                                Style="{StaticResource SecondaryButtonStyle}"
                                                Command="{Binding MergeCheckedConversationsIntoSelectedCommand}"
                                                IsEnabled="{Binding CanMergeCheckedIntoSelected}" />
                                    </DockPanel>
                                </Grid>
                            </Border>

                            <GridSplitter Grid.Column="1" Width="10" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="Transparent" />

                            <!-- Messages -->
                            <Border Grid.Column="2" Style="{StaticResource CardBorderStyle}" Padding="12">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="*" />
                                    </Grid.RowDefinitions>

                                    <DockPanel Grid.Row="0" LastChildFill="False">
                                        <TextBlock Text="Messages" Style="{StaticResource SectionHeaderTextStyle}" />
                                    </DockPanel>

                                    <TabControl Grid.Row="1" Margin="0,10,0,0">
                                        <TabItem Header="Conversation">
                                            <Grid>
                                                <DataGrid ItemsSource="{Binding ConversationMessages}"
                                                          AutoGenerateColumns="False"
                                                          IsReadOnly="True"
                                                          CanUserAddRows="False"
                                                          AlternationCount="2"
                                                          GridLinesVisibility="Horizontal"
                                                          VirtualizingPanel.IsVirtualizing="True"
                                                          VirtualizingPanel.VirtualizationMode="Recycling"
                                                          RowHeaderWidth="0"
                                                          HeadersVisibility="Column">
                                                    <DataGrid.Columns>
                                                        <DataGridTextColumn Header="When" Binding="{Binding WhenLocal}" Width="170" />
                                                        <DataGridTextColumn Header="Type" Binding="{Binding Transport}" Width="70" />
                                                        <DataGridTextColumn Header="Box" Binding="{Binding BoxLabel}" Width="80" />
                                                        <DataGridTextColumn Header="Address" Binding="{Binding AddressRaw}" Width="160" ElementStyle="{StaticResource EllipsisText}" />
                                                        <DataGridTextColumn Header="Preview" Binding="{Binding Preview}" Width="*" ElementStyle="{StaticResource EllipsisText}" />
                                                    </DataGrid.Columns>
                                                </DataGrid>

                                                <Border Background="#10FFFFFF"
                                                        BorderBrush="{DynamicResource CardBorderBrush}"
                                                        BorderThickness="1"
                                                        CornerRadius="12"
                                                    Visibility="{Binding ConversationMessageCount, Converter={StaticResource ZeroToVis}}"
                                                    IsHitTestVisible="False">
                                                    <TextBlock Text="Select a conversation to view messages."
                                                               TextAlignment="Center"
                                                               Style="{StaticResource MutedTextStyle}"
                                                               VerticalAlignment="Center" />
                                                </Border>
                                            </Grid>
                                        </TabItem>

                                        <TabItem Header="Search">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="*" />
                                                </Grid.RowDefinitions>

                                                <DockPanel Grid.Row="0" Margin="0,0,0,10" LastChildFill="True">
                                                    <TextBlock DockPanel.Dock="Left" Text="Query" VerticalAlignment="Center" Margin="0,0,10,0" Style="{StaticResource MutedTextStyle}" />
                                                    <Button DockPanel.Dock="Right" Content="Clear" Style="{StaticResource GhostButtonStyle}" Command="{Binding ClearMessageSearchCommand}" Margin="8,0,0,0" Padding="10,6" MinWidth="52" />
                                                    <Button DockPanel.Dock="Right" Content="Go" Style="{StaticResource PrimaryButtonStyle}" Command="{Binding SearchMessagesCommand}" Padding="10,6" MinWidth="40" />
                                                    <Border Style="{StaticResource RoundedInputBorderStyle}">
                                                        <TextBox Style="{StaticResource InputTextBoxStyle}" Text="{Binding MessageSearch, UpdateSourceTrigger=PropertyChanged}">
                                                            <TextBox.InputBindings>
                                                                <KeyBinding Key="Enter" Command="{Binding SearchMessagesCommand}" />
                                                            </TextBox.InputBindings>
                                                        </TextBox>
                                                    </Border>
                                                </DockPanel>

                                                <Grid Grid.Row="1">
                                                    <DataGrid ItemsSource="{Binding SearchResults}"
                                                              SelectedItem="{Binding SelectedSearchResult}"
                                                              AutoGenerateColumns="False"
                                                              IsReadOnly="True"
                                                              CanUserAddRows="False"
                                                              AlternationCount="2"
                                                              GridLinesVisibility="Horizontal"
                                                              VirtualizingPanel.IsVirtualizing="True"
                                                              VirtualizingPanel.VirtualizationMode="Recycling"
                                                              RowHeaderWidth="0"
                                                              HeadersVisibility="Column">
                                                        <DataGrid.Columns>
                                                            <DataGridTextColumn Header="When" Binding="{Binding WhenLocal}" Width="170" />
                                                            <DataGridTextColumn Header="Type" Binding="{Binding Transport}" Width="70" />
                                                            <DataGridTextColumn Header="Box" Binding="{Binding BoxLabel}" Width="80" />
                                                            <DataGridTextColumn Header="Address" Binding="{Binding AddressRaw}" Width="160" ElementStyle="{StaticResource EllipsisText}" />
                                                            <DataGridTextColumn Header="Preview" Binding="{Binding Preview}" Width="*" ElementStyle="{StaticResource EllipsisText}" />
                                                        </DataGrid.Columns>
                                                    </DataGrid>

                                                    <Border Background="#10FFFFFF"
                                                            BorderBrush="{DynamicResource CardBorderBrush}"
                                                            BorderThickness="1"
                                                            CornerRadius="12"
                                                            Visibility="{Binding SearchResultCount, Converter={StaticResource ZeroToVis}}"
                                                            IsHitTestVisible="False">
                                                        <TextBlock Text="No search results."
                                                                   TextAlignment="Center"
                                                                   Style="{StaticResource MutedTextStyle}"
                                                                   VerticalAlignment="Center" />
                                                    </Border>
                                                </Grid>
                                            </Grid>
                                        </TabItem>
                                    </TabControl>
                                </Grid>
                            </Border>
                        </Grid>
                    </TabItem>

                    <TabItem Header="Merge suggestions">
                        <Grid Margin="10">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto" />
                                <RowDefinition Height="*" />
                            </Grid.RowDefinitions>

                            <DockPanel Grid.Row="0" Margin="0,0,0,10" LastChildFill="False">
                                <StackPanel DockPanel.Dock="Left" Orientation="Horizontal" VerticalAlignment="Center">
                                    <TextBlock Text="{Binding MergeSuggestionStatus}" Style="{StaticResource MutedTextStyle}" VerticalAlignment="Center" />
                                    <TextBlock Text="  " />
                                    <TextBlock Text="Marked:" Style="{StaticResource MutedTextStyle}" VerticalAlignment="Center" />
                                    <TextBlock Text=" " />
                                    <TextBlock Text="{Binding MarkedMergeCount}" Style="{StaticResource MutedTextStyle}" VerticalAlignment="Center" />
                                </StackPanel>

                                <Button DockPanel.Dock="Right" Content="Merge marked" Style="{StaticResource SecondaryButtonStyle}" Command="{Binding AcceptMarkedMergesCommand}" Padding="10,6" Margin="8,0,0,0" />
                                <Button DockPanel.Dock="Right" Content="Clear" Style="{StaticResource GhostButtonStyle}" Command="{Binding ClearMarkedMergeSuggestionsCommand}" Padding="10,6" MinWidth="52" />
                                <Button DockPanel.Dock="Right" Content="Mark all" Style="{StaticResource GhostButtonStyle}" Command="{Binding MarkAllMergeSuggestionsCommand}" Padding="10,6" Margin="8,0,0,0" />
                                <Button DockPanel.Dock="Right" Content="Refresh" Style="{StaticResource GhostButtonStyle}" Command="{Binding RefreshMergeSuggestionsCommand}" Padding="10,4" MinWidth="72" MinHeight="28" />
                            </DockPanel>

                            <Grid Grid.Row="1">
                                <DataGrid ItemsSource="{Binding MergeSuggestions}"
                                          AutoGenerateColumns="False"
                                          CanUserAddRows="False"
                                          AlternationCount="2"
                                          GridLinesVisibility="Horizontal"
                                          VirtualizingPanel.IsVirtualizing="True"
                                          VirtualizingPanel.VirtualizationMode="Recycling">
                                    <DataGrid.Columns>
                                        <DataGridTemplateColumn Header="" Width="34" MinWidth="34">
                                            <DataGridTemplateColumn.CellStyle>
                                                <Style TargetType="DataGridCell">
                                                    <Setter Property="Padding" Value="0" />
                                                    <Setter Property="HorizontalContentAlignment" Value="Center" />
                                                </Style>
                                            </DataGridTemplateColumn.CellStyle>
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <CheckBox IsChecked="{Binding IsMarked, Mode=TwoWay}" VerticalAlignment="Center" HorizontalAlignment="Center" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>

                                        <DataGridTextColumn Header="Title" Binding="{Binding Title}" Width="240" ElementStyle="{StaticResource EllipsisText}" />

                                        <DataGridTemplateColumn Header="Details" Width="*">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Details}" TextWrapping="Wrap" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>

                                        <DataGridTemplateColumn Header="" Width="90">
                                            <DataGridTemplateColumn.CellTemplate>
                                                <DataTemplate>
                                                    <Button Content="Apply" Style="{StaticResource GhostButtonStyle}"
                                                            Command="{Binding DataContext.ApplySuggestedMergeCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                            CommandParameter="{Binding}" />
                                                </DataTemplate>
                                            </DataGridTemplateColumn.CellTemplate>
                                        </DataGridTemplateColumn>
                                    </DataGrid.Columns>
                                </DataGrid>

                                <Border Background="#10FFFFFF"
                                        BorderBrush="{DynamicResource CardBorderBrush}"
                                        BorderThickness="1"
                                        CornerRadius="12"
                                        Visibility="{Binding MergeSuggestionCount, Converter={StaticResource ZeroToVis}}"
                                        IsHitTestVisible="False">
                                    <TextBlock Text="{Binding MergeSuggestionStatus}"
                                               TextAlignment="Center"
                                               Style="{StaticResource MutedTextStyle}"
                                               VerticalAlignment="Center" />
                                </Border>
                            </Grid>
                        </Grid>
                    </TabItem>

                    <TabItem Header="Maintenance">
                        <Border Padding="12">
                            <StackPanel>
                                <TextBlock Text="Maintenance" Style="{StaticResource SectionHeaderTextStyle}" />
                                <TextBlock Margin="0,8,0,0" TextWrapping="Wrap" Style="{StaticResource MutedTextStyle}">
                                    Project-level maintenance operations. Each action may modify stored phone numbers and will rebuild conversation metadata where required. Use with caution.
                                </TextBlock>

                                <!-- Repair legacy +10 numbers -->
                                <TextBlock Text="Repair legacy +10 numbers" Style="{StaticResource SectionHeaderTextStyle}" Margin="0,12,0,0" />
                                <TextBlock Margin="0,4,0,0" TextWrapping="Wrap" Style="{StaticResource MutedTextStyle}">
                                    Fixes normalized addresses that were incorrectly stored as "+10..." back to "+0..." and rebuilds conversation data.
                                </TextBlock>
                                <Button Content="Repair +10→+0" Style="{StaticResource SecondaryButtonStyle}"
                                        Command="{Binding RepairPhoneNumbersCommand}"
                                        IsEnabled="{Binding IsNotBusy}" Margin="0,8,0,0" />

                                <!-- Remove spaces -->
                                <TextBlock Text="Remove spaces from numbers" Style="{StaticResource SectionHeaderTextStyle}" Margin="0,12,0,0" />
                                <TextBlock Margin="0,4,0,0" TextWrapping="Wrap" Style="{StaticResource MutedTextStyle}">
                                    Removes any spaces from stored phone numbers in `sms` and `mms_addr` tables (both raw and normalized forms).
                                </TextBlock>
                                <Button Content="Remove spaces" Style="{StaticResource SecondaryButtonStyle}"
                                        Command="{Binding RemoveSpacesFromNumbersCommand}"
                                        IsEnabled="{Binding IsNotBusy}" Margin="0,8,0,0" />

                                <!-- Add +61 / remove leading 0 -->
                                <TextBlock Text="Convert leading 0 to +61" Style="{StaticResource SectionHeaderTextStyle}" Margin="0,12,0,0" />
                                <TextBlock Margin="0,4,0,0" TextWrapping="Wrap" Style="{StaticResource MutedTextStyle}">
                                    Prefixes "+61" and removes a single leading 0 from normalized addresses (e.g., "0412..." → "+61412..."). This may merge recipients and rebuild conversations.
                                </TextBlock>
                                <Button Content="Add +61 / remove leading 0" Style="{StaticResource SecondaryButtonStyle}"
                                        Command="{Binding AddPlus61NumbersCommand}"
                                        IsEnabled="{Binding IsNotBusy}" Margin="0,8,0,0" />
                            </StackPanel>
                        </Border>
                    </TabItem>

                    <TabItem Header="Log">
                        <Border Padding="6">
                            <TextBox Text="{Binding LogText}"
                                     IsReadOnly="True"
                                     VerticalScrollBarVisibility="Auto"
                                     HorizontalScrollBarVisibility="Auto"
                                     TextWrapping="NoWrap"
                                     FontFamily="Consolas" />
                        </Border>
                    </TabItem>
                </TabControl>
            </Border>
        </Grid>

        <!-- Bottom status -->
        <Border Grid.Row="2" Style="{StaticResource CardBorderStyle}" Padding="10" Margin="0,14,0,0">
            <DockPanel>
                <TextBlock Text="{Binding BusyText}" Style="{StaticResource MutedTextStyle}" />
                <ProgressBar DockPanel.Dock="Left" Width="180" Height="14" IsIndeterminate="True" Visibility="{Binding IsBusy, Converter={StaticResource BoolToVis}}" />
            </DockPanel>
        </Border>
    </Grid>
</Window>
