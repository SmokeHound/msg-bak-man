<Window x:Class="MsgBakMan.App.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:MsgBakMan.App"
        xmlns:conv="clr-namespace:MsgBakMan.App.Converters"
    xmlns:ui="http://schemas.modernwpf.com/2019"
        mc:Ignorable="d"
    ui:WindowHelper.UseModernWindowStyle="True"
        Title="MsgBakMan" Height="600" Width="920" WindowState="Maximized" Icon="Assets/msgbakman.ico">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
        <conv:EmptyCollectionToVisibilityConverter x:Key="EmptyToVis" />
    </Window.Resources>
    <Grid Background="{DynamicResource AppBackgroundBrush}" Margin="14">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- Top app bar -->
        <Border Grid.Row="0" Style="{StaticResource CardBorderStyle}" Padding="16" Margin="0,0,0,14">
            <DockPanel LastChildFill="False">
                <StackPanel DockPanel.Dock="Left">
                    <TextBlock Text="Message Backup Manager" Style="{StaticResource AppTitleTextStyle}" />
                    <TextBlock Text="Import, merge, and export SMS backups" Style="{StaticResource AppSubtitleTextStyle}" />
                </StackPanel>

                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Center">
                    <Border Style="{StaticResource RoundedInputBorderStyle}" Padding="10,3" Margin="0,0,12,0" VerticalAlignment="Center">
                        <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                            <Ellipse Width="10" Height="10" Fill="{DynamicResource AccentBrush}" Margin="0,0,8,0" />
                            <ComboBox ItemsSource="{Binding AccentPalettes}"
                                      SelectedItem="{Binding SelectedAccentPalette, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                      MinWidth="110"
                                      Style="{StaticResource CompactComboBoxStyle}" />
                        </StackPanel>
                    </Border>
                    <ui:ToggleSwitch Header="Dark" IsOn="{Binding IsDarkTheme, Mode=TwoWay}" Margin="0,0,12,0" VerticalAlignment="Center" />
                    <Button Content="About" Style="{StaticResource GhostButtonStyle}" Click="About_Click" />
                </StackPanel>
            </DockPanel>
        </Border>

        <!-- Main content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="360" />
                <ColumnDefinition Width="12" />
                <ColumnDefinition Width="*" />
            </Grid.ColumnDefinitions>

            <!-- Left sidebar -->
            <StackPanel Grid.Column="0">
                <Border Style="{StaticResource CardBorderStyle}">
                    <StackPanel>
                        <TextBlock Text="Project" Style="{StaticResource SectionHeaderTextStyle}" />
                        <TextBlock Text="Choose where the database + media live." Style="{StaticResource MutedTextStyle}" Margin="0,4,0,0" />

                        <Border Style="{StaticResource RoundedInputBorderStyle}" Margin="0,12,0,0">
                            <DockPanel LastChildFill="True">
                                <TextBox Style="{StaticResource InputTextBoxStyle}" Text="{Binding ProjectFolder, UpdateSourceTrigger=PropertyChanged}" />
                                <Button DockPanel.Dock="Right" Content="Browse" Style="{StaticResource GhostButtonStyle}" Command="{Binding BrowseProjectFolderCommand}" Margin="10,0,0,0" />
                            </DockPanel>
                        </Border>

                        <TextBlock Text="DB: db/messages.sqlite • Media: media/blobs/" Style="{StaticResource MutedTextStyle}" Margin="0,10,0,0" />
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource CardBorderStyle}" Margin="0,14,0,0">
                    <StackPanel>
                        <TextBlock Text="Actions" Style="{StaticResource SectionHeaderTextStyle}" />
                        <TextBlock Text="Import multiple backups and export one merged file." Style="{StaticResource MutedTextStyle}" Margin="0,4,0,0" />

                        <Button Content="Import XML" Style="{StaticResource PrimaryButtonStyle}" Margin="0,12,0,0" Command="{Binding ImportXmlCommand}" IsEnabled="{Binding IsNotBusy}" />
                        <Button Content="Export merged XML" Style="{StaticResource PrimaryButtonStyle}" Margin="0,10,0,0" Command="{Binding ExportXmlCommand}" IsEnabled="{Binding IsNotBusy}" />

                        <DockPanel Margin="0,12,0,0" LastChildFill="True">
                            <Button DockPanel.Dock="Right" Content="Refresh" Style="{StaticResource SecondaryButtonStyle}" Command="{Binding RefreshConversationsCommand}" IsEnabled="{Binding IsNotBusy}" />
                            <TextBlock Text="{Binding BusyText}" VerticalAlignment="Center" Style="{StaticResource MutedTextStyle}" Margin="0,0,10,0" />
                        </DockPanel>
                    </StackPanel>
                </Border>

                <Border Style="{StaticResource CardBorderStyle}" Margin="0,14,0,0">
                    <StackPanel>
                        <TextBlock Text="Overview" Style="{StaticResource SectionHeaderTextStyle}" />
                        <StackPanel Orientation="Horizontal" Margin="0,10,0,0">
                            <Border Background="#10FFFFFF" CornerRadius="10" Padding="10" Margin="0,0,10,0">
                                <StackPanel>
                                    <TextBlock Text="Conversations" Style="{StaticResource MutedTextStyle}" />
                                    <TextBlock Text="{Binding ConversationCount}" FontSize="20" FontWeight="SemiBold" />
                                </StackPanel>
                            </Border>
                            <Border Background="#10FFFFFF" CornerRadius="10" Padding="10" Margin="0,0,10,0">
                                <StackPanel>
                                    <TextBlock Text="Messages" Style="{StaticResource MutedTextStyle}" />
                                    <TextBlock Text="{Binding ConversationMessageCount}" FontSize="20" FontWeight="SemiBold" />
                                </StackPanel>
                            </Border>
                            <Border Background="#10FFFFFF" CornerRadius="10" Padding="10">
                                <StackPanel>
                                    <TextBlock Text="Results" Style="{StaticResource MutedTextStyle}" />
                                    <TextBlock Text="{Binding SearchResultCount}" FontSize="20" FontWeight="SemiBold" />
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </StackPanel>

            <GridSplitter Grid.Column="1" Width="12" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="Transparent" />

            <!-- Right content -->
            <Border Grid.Column="2" Style="{StaticResource CardBorderStyle}" Padding="12">
                <TabControl>
                    <TabItem Header="Browse">
                        <Grid Margin="4">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="420" MinWidth="320" />
                                <ColumnDefinition Width="10" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>

                            <!-- Conversations -->
                            <Border Grid.Column="0" Style="{StaticResource CardBorderStyle}" Padding="12">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="*" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <TextBlock Text="Conversations" Style="{StaticResource SectionHeaderTextStyle}" />

                                    <DockPanel Grid.Row="1" Margin="0,10,0,0" LastChildFill="True">
                                        <Border Style="{StaticResource RoundedInputBorderStyle}" Margin="0,0,10,0">
                                            <TextBox Style="{StaticResource InputTextBoxStyle}" Text="{Binding ConversationSearch, UpdateSourceTrigger=PropertyChanged}" />
                                        </Border>
                                        <Button DockPanel.Dock="Right" Content="Clear" Style="{StaticResource GhostButtonStyle}" Command="{Binding ClearConversationSearchCommand}" Margin="10,0,0,0" />
                                        <Button DockPanel.Dock="Right" Content="Load" Style="{StaticResource SecondaryButtonStyle}" Command="{Binding RefreshConversationsCommand}" Padding="10,6" MinWidth="56" />
                                    </DockPanel>

                                    <Grid Grid.Row="2" Margin="0,10,0,0">
                                        <ListBox ItemsSource="{Binding Conversations}"
                                                 SelectedItem="{Binding SelectedConversation}"
                                                 BorderThickness="0"
                                                 ScrollViewer.VerticalScrollBarVisibility="Auto"
                                                 VirtualizingStackPanel.IsVirtualizing="True"
                                                 VirtualizingStackPanel.VirtualizationMode="Recycling">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Padding="8" CornerRadius="10" Background="Transparent">
                                                        <DockPanel>
                                                            <CheckBox IsChecked="{Binding IsChecked}" VerticalAlignment="Center" Margin="0,0,10,0" />
                                                            <StackPanel>
                                                                <TextBlock Text="{Binding Display}" Style="{StaticResource EllipsisText}" />
                                                                <TextBlock FontSize="11" Style="{StaticResource MutedTextStyle}">
                                                                    <Run Text="Messages: " /><Run Text="{Binding MessageCount, Mode=OneWay}" />
                                                                    <Run Text="  •  Last: " /><Run Text="{Binding LastWhenLocal, Mode=OneWay}" />
                                                                </TextBlock>
                                                            </StackPanel>
                                                        </DockPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>

                                        <Border Background="#10FFFFFF"
                                                BorderBrush="{DynamicResource CardBorderBrush}"
                                                BorderThickness="1"
                                                CornerRadius="12"
                                                Visibility="{Binding Conversations, Converter={StaticResource EmptyToVis}}">
                                            <TextBlock Text="No conversations yet.\nImport XML and press Refresh."
                                                       TextAlignment="Center"
                                                       Style="{StaticResource MutedTextStyle}"
                                                       VerticalAlignment="Center" />
                                        </Border>
                                    </Grid>

                                    <DockPanel Grid.Row="3" Margin="0,10,0,0" LastChildFill="False">
                                        <StackPanel Orientation="Horizontal" DockPanel.Dock="Left">
                                            <Button Content="Check all" Style="{StaticResource GhostButtonStyle}" Command="{Binding CheckAllConversationsCommand}" />
                                            <Button Content="None" Style="{StaticResource GhostButtonStyle}" Command="{Binding UncheckAllConversationsCommand}" Margin="8,0,0,0" />
                                        </StackPanel>

                                        <Button DockPanel.Dock="Right"
                                                Content="Merge checked"
                                                Style="{StaticResource SecondaryButtonStyle}"
                                                Command="{Binding MergeCheckedConversationsIntoSelectedCommand}"
                                                IsEnabled="{Binding CanMergeCheckedIntoSelected}" />
                                    </DockPanel>
                                </Grid>
                            </Border>

                            <GridSplitter Grid.Column="1" Width="10" HorizontalAlignment="Stretch" VerticalAlignment="Stretch" Background="Transparent" />

                            <!-- Messages -->
                            <Border Grid.Column="2" Style="{StaticResource CardBorderStyle}" Padding="12">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="*" />
                                    </Grid.RowDefinitions>

                                    <DockPanel Grid.Row="0" LastChildFill="False">
                                        <TextBlock Text="Messages" Style="{StaticResource SectionHeaderTextStyle}" />
                                    </DockPanel>

                                    <TabControl Grid.Row="1" Margin="0,10,0,0">
                                        <TabItem Header="Conversation">
                                            <Grid>
                                                <DataGrid ItemsSource="{Binding ConversationMessages}"
                                                          AutoGenerateColumns="False"
                                                          IsReadOnly="True"
                                                          CanUserAddRows="False"
                                                          AlternationCount="2"
                                                          GridLinesVisibility="Horizontal"
                                                          VirtualizingPanel.IsVirtualizing="True"
                                                          VirtualizingPanel.VirtualizationMode="Recycling">
                                                    <DataGrid.Columns>
                                                        <DataGridTextColumn Header="When" Binding="{Binding WhenLocal}" Width="170" />
                                                        <DataGridTextColumn Header="Type" Binding="{Binding Transport}" Width="70" />
                                                        <DataGridTextColumn Header="Box" Binding="{Binding BoxLabel}" Width="80" />
                                                        <DataGridTextColumn Header="Address" Binding="{Binding AddressRaw}" Width="160" ElementStyle="{StaticResource EllipsisText}" />
                                                        <DataGridTextColumn Header="Preview" Binding="{Binding Preview}" Width="*" ElementStyle="{StaticResource EllipsisText}" />
                                                    </DataGrid.Columns>
                                                </DataGrid>

                                                <Border Background="#10FFFFFF"
                                                        BorderBrush="{DynamicResource CardBorderBrush}"
                                                        BorderThickness="1"
                                                        CornerRadius="12"
                                                        Visibility="{Binding ConversationMessages, Converter={StaticResource EmptyToVis}}">
                                                    <TextBlock Text="Select a conversation to view messages."
                                                               TextAlignment="Center"
                                                               Style="{StaticResource MutedTextStyle}"
                                                               VerticalAlignment="Center" />
                                                </Border>
                                            </Grid>
                                        </TabItem>

                                        <TabItem Header="Search">
                                            <Grid>
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto" />
                                                    <RowDefinition Height="*" />
                                                </Grid.RowDefinitions>

                                                <DockPanel Grid.Row="0" Margin="0,0,0,10" LastChildFill="True">
                                                    <TextBlock Text="Query" VerticalAlignment="Center" Margin="0,0,10,0" Style="{StaticResource MutedTextStyle}" />
                                                    <Border Style="{StaticResource RoundedInputBorderStyle}">
                                                        <TextBox Style="{StaticResource InputTextBoxStyle}" Text="{Binding MessageSearch, UpdateSourceTrigger=PropertyChanged}">
                                                            <TextBox.InputBindings>
                                                                <KeyBinding Key="Enter" Command="{Binding SearchMessagesCommand}" />
                                                            </TextBox.InputBindings>
                                                        </TextBox>
                                                    </Border>
                                                    <Button DockPanel.Dock="Right" Content="Clear" Style="{StaticResource GhostButtonStyle}" Command="{Binding ClearMessageSearchCommand}" Margin="10,0,0,0" />
                                                    <Button DockPanel.Dock="Right" Content="Go" Style="{StaticResource PrimaryButtonStyle}" Command="{Binding SearchMessagesCommand}" />
                                                </DockPanel>

                                                <Grid Grid.Row="1">
                                                    <DataGrid ItemsSource="{Binding SearchResults}"
                                                              SelectedItem="{Binding SelectedSearchResult}"
                                                              AutoGenerateColumns="False"
                                                              IsReadOnly="True"
                                                              CanUserAddRows="False"
                                                              AlternationCount="2"
                                                              GridLinesVisibility="Horizontal"
                                                              VirtualizingPanel.IsVirtualizing="True"
                                                              VirtualizingPanel.VirtualizationMode="Recycling">
                                                        <DataGrid.Columns>
                                                            <DataGridTextColumn Header="When" Binding="{Binding WhenLocal}" Width="170" />
                                                            <DataGridTextColumn Header="Type" Binding="{Binding Transport}" Width="70" />
                                                            <DataGridTextColumn Header="Box" Binding="{Binding BoxLabel}" Width="80" />
                                                            <DataGridTextColumn Header="Address" Binding="{Binding AddressRaw}" Width="160" ElementStyle="{StaticResource EllipsisText}" />
                                                            <DataGridTextColumn Header="Preview" Binding="{Binding Preview}" Width="*" ElementStyle="{StaticResource EllipsisText}" />
                                                        </DataGrid.Columns>
                                                    </DataGrid>

                                                    <Border Background="#10FFFFFF"
                                                            BorderBrush="{DynamicResource CardBorderBrush}"
                                                            BorderThickness="1"
                                                            CornerRadius="12"
                                                            Visibility="{Binding SearchResults, Converter={StaticResource EmptyToVis}}">
                                                        <TextBlock Text="No search results."
                                                                   TextAlignment="Center"
                                                                   Style="{StaticResource MutedTextStyle}"
                                                                   VerticalAlignment="Center" />
                                                    </Border>
                                                </Grid>
                                            </Grid>
                                        </TabItem>
                                    </TabControl>
                                </Grid>
                            </Border>
                        </Grid>
                    </TabItem>

                    <TabItem Header="Log">
                        <Border Padding="6">
                            <TextBox Text="{Binding LogText}"
                                     IsReadOnly="True"
                                     VerticalScrollBarVisibility="Auto"
                                     HorizontalScrollBarVisibility="Auto"
                                     TextWrapping="NoWrap"
                                     FontFamily="Consolas" />
                        </Border>
                    </TabItem>
                </TabControl>
            </Border>
        </Grid>

        <!-- Bottom status -->
        <Border Grid.Row="2" Style="{StaticResource CardBorderStyle}" Padding="10" Margin="0,14,0,0">
            <DockPanel>
                <TextBlock Text="{Binding BusyText}" Style="{StaticResource MutedTextStyle}" />
                <ProgressBar DockPanel.Dock="Right" Width="180" Height="14" IsIndeterminate="True" Visibility="{Binding IsBusy, Converter={StaticResource BoolToVis}}" />
            </DockPanel>
        </Border>
    </Grid>
</Window>
